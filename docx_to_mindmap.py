#!/usr/bin/env python3
"""
PDF è½¬æ€ç»´å¯¼å›¾å·¥å…·
è¯»å– PDF æ–‡ä»¶ï¼Œæå–å†…å®¹å¹¶ç”Ÿæˆ Markdown æ ¼å¼çš„æ€ç»´å¯¼å›¾
"""

import os
import re
from pathlib import Path
from docx import Document
from openai import OpenAI
from dotenv import load_dotenv


def extract_docx_text(docx_path):
    """æå– Word æ–‡æ¡£æ–‡æœ¬å†…å®¹"""
    import sys

    print(f"æ­£åœ¨è¯»å– DOCX: {docx_path}")
    sys.stdout.flush()

    doc = Document(docx_path)
    text_content = []

    # è¯»å–æ‰€æœ‰æ®µè½
    for i, para in enumerate(doc.paragraphs):
        text = para.text.strip()
        if text:
            text_content.append(text)

        if (i + 1) % 100 == 0:
            print(f"å¤„ç†ç¬¬ {i+1} æ®µ")
            sys.stdout.flush()

    # è¯»å–æ‰€æœ‰è¡¨æ ¼
    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                text = cell.text.strip()
                if text:
                    text_content.append(text)

    full_text = "\n".join(text_content)
    print(f"DOCX æ–‡æœ¬æå–å®Œæˆ")
    print(f"æ€»æ®µè½æ•°: {len(doc.paragraphs)}")
    print(f"æ€»å­—ç¬¦æ•°: {len(full_text)}")
    sys.stdout.flush()

    return full_text


def extract_pdf_text_pymupdf(pdf_path, max_pages=None):
    """ä½¿ç”¨ PyMuPDF æå– PDF æ–‡æœ¬å†…å®¹"""
    import sys
    text_content = []

    print(f"æ­£åœ¨è¯»å– PDF (PyMuPDF): {pdf_path}")
    sys.stdout.flush()

    doc = fitz.open(pdf_path)
    total_pages = len(doc)
    pages_to_process = min(max_pages, total_pages) if max_pages else total_pages

    print(f"PDF æ€»é¡µæ•°: {total_pages}ï¼Œå°†å¤„ç†: {pages_to_process} é¡µ")
    sys.stdout.flush()

    for i in range(pages_to_process):
        if (i + 1) % 10 == 0:  # æ¯10é¡µè¾“å‡ºä¸€æ¬¡
            print(f"å¤„ç†ç¬¬ {i+1}/{pages_to_process} é¡µ")
            sys.stdout.flush()
        page = doc[i]
        text = page.get_text()
        if text and text.strip():
            text_content.append(text)

    doc.close()

    print(f"PDF æ–‡æœ¬æå–å®Œæˆï¼Œå…± {len(text_content)} é¡µæœ‰æ•ˆå†…å®¹")
    print(f"æ€»å­—ç¬¦æ•°: {sum(len(t) for t in text_content)}")
    sys.stdout.flush()
    return "\n\n".join(text_content)


def extract_pdf_text(pdf_path, max_pages=None):
    """æå– PDF æ–‡æœ¬å†…å®¹ï¼ˆä¼˜å…ˆä½¿ç”¨ PyMuPDFï¼‰"""
    import sys

    # å…ˆå°è¯•ä½¿ç”¨ PyMuPDF
    try:
        text = extract_pdf_text_pymupdf(pdf_path, max_pages)
        if text and len(text.strip()) > 100:  # å¦‚æœæå–åˆ°äº†æœ‰æ•ˆæ–‡æœ¬
            return text
        print(f"PyMuPDF æå–æ–‡æœ¬å¤ªå°‘ï¼Œå°è¯•ä½¿ç”¨ pdfplumber")
        sys.stdout.flush()
    except Exception as e:
        print(f"PyMuPDF æå–å¤±è´¥: {e}ï¼Œå°è¯•ä½¿ç”¨ pdfplumber")
        sys.stdout.flush()

    # å¦‚æœ PyMuPDF å¤±è´¥ï¼Œå°è¯• pdfplumber
    text_content = []
    print(f"æ­£åœ¨è¯»å– PDF (pdfplumber): {pdf_path}")
    sys.stdout.flush()

    with pdfplumber.open(pdf_path) as pdf:
        total_pages = len(pdf.pages)
        pages_to_process = min(max_pages, total_pages) if max_pages else total_pages

        print(f"PDF æ€»é¡µæ•°: {total_pages}ï¼Œå°†å¤„ç†: {pages_to_process} é¡µ")
        sys.stdout.flush()

        for i, page in enumerate(pdf.pages[:pages_to_process]):
            if (i + 1) % 10 == 0:  # æ¯10é¡µè¾“å‡ºä¸€æ¬¡
                print(f"å¤„ç†ç¬¬ {i+1}/{pages_to_process} é¡µ")
                sys.stdout.flush()
            text = page.extract_text()
            if text:
                text_content.append(text)

    print(f"PDF æ–‡æœ¬æå–å®Œæˆï¼Œå…± {len(text_content)} é¡µ")
    sys.stdout.flush()
    return "\n\n".join(text_content)


def generate_mindmap_md(pdf_text, pdf_name):
    """ä½¿ç”¨ AI API ç”Ÿæˆæ€ç»´å¯¼å›¾ Markdown"""
    import sys

    api_key = os.getenv("DASHSCOPE_API_KEY")

    if not api_key:
        print("è­¦å‘Š: æœªæ‰¾åˆ° DASHSCOPE_API_KEYï¼Œå°†ä½¿ç”¨ç®€å•çš„ç»“æ„æå–")
        sys.stdout.flush()
        return generate_simple_mindmap(pdf_text, pdf_name)

    client = OpenAI(
        api_key=api_key,
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    )

    # å¦‚æœæ–‡æœ¬å¤ªé•¿ï¼Œåˆ†æ‰¹å¤„ç†
    text_length = len(pdf_text)
    max_chunk_size = 100000  # æ¯æ¬¡å¤„ç†æœ€å¤š 10ä¸‡å­—ç¬¦

    print(f"PDF æ–‡æœ¬æ€»é•¿åº¦: {text_length} å­—ç¬¦")
    sys.stdout.flush()

    prompt = f"""è¯·ä»”ç»†åˆ†æä»¥ä¸‹æ•™æå†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªè¯¦ç»†å®Œæ•´çš„ Markdown æ ¼å¼èƒŒè¯µè„‘å›¾ã€‚

ã€æ ¼å¼è¦æ±‚ - éå¸¸é‡è¦ã€‘
1. å¿…é¡»ä½¿ç”¨æ ‡å‡† Markdown æ ‡é¢˜æ ¼å¼ï¼š
   - ä¸€çº§æ ‡é¢˜ç”¨ # ï¼ˆä¹¦åï¼‰
   - äºŒçº§æ ‡é¢˜ç”¨ ## ï¼ˆç« èŠ‚åï¼‰
   - ä¸‰çº§æ ‡é¢˜ç”¨ ### ï¼ˆå°èŠ‚åï¼‰
   - å››çº§æ ‡é¢˜ç”¨ #### ï¼ˆçŸ¥è¯†ç‚¹ï¼‰
   - äº”çº§æ ‡é¢˜ç”¨ ##### ï¼ˆå­çŸ¥è¯†ç‚¹ï¼‰

2. ç¤ºä¾‹æ ¼å¼ï¼š
```
# æ•™æåç§°

## ç¬¬ä¸€ç«  ç« èŠ‚åç§°

### 1.1 å°èŠ‚åç§°

#### çŸ¥è¯†ç‚¹1 3
ï¼ˆè¡¨ç¤ºè¿™ä¸ªçŸ¥è¯†ç‚¹æœ‰3æ¡è¦ç‚¹ï¼‰

##### å­çŸ¥è¯†ç‚¹1.1 2

##### å­çŸ¥è¯†ç‚¹1.2

#### çŸ¥è¯†ç‚¹2 5

### 1.2 å°èŠ‚åç§°

#### çŸ¥è¯†ç‚¹3 4
```

ã€å†…å®¹è¦æ±‚ - ğŸ”´ å¿…é¡»æå…¶è¯¦ç»†å®Œæ•´ ğŸ”´ã€‘

1. **å®Œæ•´æ€§ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**ï¼š
   - å¿…é¡»é€å­—é€å¥åˆ†ææ•™æï¼Œä¸èƒ½é—æ¼ä»»ä½•çŸ¥è¯†ç‚¹
   - æ¯ä¸€æ®µè½ã€æ¯ä¸€ä¸ªå°æ ‡é¢˜éƒ½è¦æå–
   - æ‰€æœ‰å›¾è¡¨è¯´æ˜ã€æ³¨é‡Šã€è¡¥å……å†…å®¹éƒ½è¦åŒ…å«
   - å³ä½¿æ˜¯å¾ˆå°çš„çŸ¥è¯†ç‚¹ä¹Ÿè¦åˆ—å‡ºæ¥

2. **è¯¦ç»†æ€§ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**ï¼š
   - **æ·±åº¦è¦æ±‚**ï¼šè‡³å°‘è¦æœ‰ 4-6 å±‚çº§çš„å±‚æ¬¡ç»“æ„
   - **é‡è¦**ï¼šåªå†™çŸ¥è¯†ç‚¹çš„**åç§°**å’Œ**æ•°é‡**ï¼Œä¸å†™å…·ä½“å†…å®¹
   - æ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½è¦**è¯†åˆ«æ‰€æœ‰å­çŸ¥è¯†ç‚¹**ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
     * å®šä¹‰
     * ç»„æˆ
     * åˆ†ç±»
     * ç»“æ„
     * æ€§è´¨
     * åŠŸèƒ½
     * è¿‡ç¨‹
     * å½±å“å› ç´ 
     * è°ƒèŠ‚æœºåˆ¶
     * ç”Ÿç†æ„ä¹‰
     * åº”ç”¨
     * ä¾‹å­

   - **å±‚çº§å±•å¼€ç¤ºä¾‹**ï¼ˆåªå†™åç§°+æ•°é‡ï¼Œä¸å†™å†…å®¹ï¼‰ï¼š
     ```
     ## ç¬¬Xç«  é…¶
     ### X.1 é…¶çš„åŒ–å­¦æœ¬è´¨
     #### é…¶çš„ç»„æˆ
     ##### å•çº¯é…¶ 2
     ##### ç»“åˆé…¶
     ###### é…¶è›‹ç™½ 3
     ###### è¾…å› å­
     ####### è¾…é…¶ 3
     ####### è¾…åŸº 3
     #### é…¶ç»„æˆå½¢å¼ 4
     ##### å•ä½“é…¶ 2
     ##### å¯¡èšé…¶ 3
     ##### å¤šé…¶ä½“ç³» 2
     ##### å¤šåŠŸèƒ½é…¶ 2
     ```

   æ³¨æ„ï¼šä¸Šé¢ç¤ºä¾‹ä¸­
   - "å•çº¯é…¶ 2" è¡¨ç¤ºå•çº¯é…¶æœ‰2ä¸ªè¦ç‚¹è¦èƒŒè¯µï¼ˆä¸å†™å‡ºé‚£2ä¸ªè¦ç‚¹æ˜¯ä»€ä¹ˆï¼‰
   - "é…¶è›‹ç™½ 3" è¡¨ç¤ºé…¶è›‹ç™½æœ‰3ä¸ªè¦ç‚¹è¦èƒŒè¯µï¼ˆä¸å†™å‡ºé‚£3ä¸ªè¦ç‚¹æ˜¯ä»€ä¹ˆï¼‰
   - "é…¶ç»„æˆå½¢å¼ 4" è¡¨ç¤ºåŸæ–‡æ˜ç¡®è¯´äº†æœ‰4ç§å½¢å¼

3. **å±‚æ¬¡æ€§**ï¼š
   - å¿…é¡»æœ‰æ¸…æ™°çš„å±‚çº§ç»“æ„ï¼šç«  â†’ èŠ‚ â†’ å¤§çŸ¥è¯†ç‚¹ â†’ å°çŸ¥è¯†ç‚¹ â†’ å…·ä½“è¦ç‚¹ â†’ ç»†èŠ‚è¦ç‚¹
   - æ¯ä¸ªå±‚çº§éƒ½è¦å®Œæ•´ï¼Œä¸èƒ½è·³çº§
   - ä½¿ç”¨ ##, ###, ####, #####, ######, ####### ç­‰å¤šçº§æ ‡é¢˜
4. **æ ‡æ³¨æ•°é‡è§„åˆ™**ï¼ˆğŸ”´ğŸ”´ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ ğŸ”´ğŸ”´ğŸ”´ï¼‰ï¼š

   **ã€æ ¸å¿ƒåŸåˆ™ã€‘**
   - âœ… **æ‰€æœ‰æœ€å¤–å±‚å¶å­èŠ‚ç‚¹ï¼ˆä¸‹é¢æ²¡æœ‰å­èŠ‚ç‚¹ï¼‰å¿…é¡»æ ‡æ•°å­—** - ç”¨äºèƒŒè¯µæ—¶è®¡æ•°
   - âŒ **ä¸­é—´èŠ‚ç‚¹ï¼ˆä¸‹é¢è¿˜æœ‰å­èŠ‚ç‚¹ï¼‰é»˜è®¤ä¸æ ‡æ•°å­—** - é™¤éåŸæ–‡æ˜ç¡®æ ‡æ³¨äº†åºå·

   **ã€ä¸‰æ­¥åˆ¤æ–­æ³•ã€‘**

   **ç¬¬1æ­¥ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹**
   - çœ‹è¿™ä¸ªæ ‡é¢˜ä¸‹é¢æ˜¯å¦è¿˜æœ‰æ›´æ·±å±‚çº§çš„å­æ ‡é¢˜
   - å¦‚æœä¸‹é¢æ²¡æœ‰å­æ ‡é¢˜ â†’ å¶å­èŠ‚ç‚¹ â†’ **å¿…é¡»æ ‡æ•°å­—**
   - å¦‚æœä¸‹é¢è¿˜æœ‰å­æ ‡é¢˜ â†’ ä¸­é—´èŠ‚ç‚¹ â†’ **è¿›å…¥ç¬¬2æ­¥**

   **ç¬¬2æ­¥ï¼šåˆ¤æ–­åŸæ–‡æ˜¯å¦æ˜ç¡®æ ‡æ³¨åºå·**ï¼ˆä»…é’ˆå¯¹ä¸­é—´èŠ‚ç‚¹ï¼‰
   - æ£€æŸ¥åŸæ–‡åœ¨ä»‹ç»è¿™ä¸ªçŸ¥è¯†ç‚¹æ—¶ï¼Œæ˜¯å¦æ˜ç¡®å†™äº†åºå·ï¼Œæ¯”å¦‚:
     * "æœ‰4ç§åŒ–å­¦æ€§è´¨ï¼š(1)...(2)...(3)...(4)..."
     * "åŒ…æ‹¬ä»¥ä¸‹3ç±»ï¼š1. ... 2. ... 3. ..."
     * "åˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼šä¸€ã€äºŒã€ä¸‰ã€å››ã€äº”"
   - å¦‚æœåŸæ–‡**æ˜ç¡®æ ‡æ³¨äº†åºå·** â†’ **æ ‡æ•°å­—**ï¼ˆè¿™æ ·æ–¹ä¾¿èƒŒè¯µæ—¶è®°ä½æœ‰å‡ ä¸ªï¼‰
   - å¦‚æœåŸæ–‡**æ²¡æœ‰æ˜ç¡®æ ‡æ³¨** â†’ **ä¸æ ‡æ•°å­—**

   **ç¬¬3æ­¥ï¼šæ•°æ•°å­—**
   - å¦‚æœéœ€è¦æ ‡æ•°å­—ï¼Œæ•°ä¸€ä¸‹æœ‰å‡ ä¸ªå­è¦ç‚¹

   **ã€é”™è¯¯ç¤ºä¾‹ âŒã€‘**
   ```
   âŒ é”™è¯¯ï¼šåŸæ–‡åªæ˜¯å¹³é“ºç›´å™"æ°¨åŸºé…¸æœ‰å¤šç§æ€§è´¨ï¼ŒåŒ…æ‹¬ç‰©ç†æ€§è´¨å’ŒåŒ–å­¦æ€§è´¨"
           ä½†ä½ æ ‡äº†æ•°å­—ï¼š
   #### æ°¨åŸºé…¸çš„æ€§è´¨ 2              ï¼ˆâŒ åŸæ–‡æ²¡æ˜ç¡®æ ‡åºå·ï¼Œä¸åº”æ ‡æ•°å­—ï¼‰
   ##### ç‰©ç†æ€§è´¨ 3
   ##### åŒ–å­¦æ€§è´¨ 4

   âŒ é”™è¯¯ï¼šåŸæ–‡åªæ˜¯è¯´"æ°¨åŸºé…¸åˆ†ä¸ºæ ‡å‡†å’Œéæ ‡å‡†"
           ä½†ä½ æ ‡äº†æ•°å­—ï¼š
   #### æ°¨åŸºé…¸åˆ†ç±» 2                ï¼ˆâŒ åŸæ–‡æ²¡æ˜ç¡®æ ‡åºå·ï¼Œä¸åº”æ ‡æ•°å­—ï¼‰
   ##### æ ‡å‡†æ°¨åŸºé…¸
   ###### ææ€§æ°¨åŸºé…¸ 2
   ###### éææ€§æ°¨åŸºé…¸ 3
   ##### éæ ‡å‡†æ°¨åŸºé…¸ 2
   ```

   **ã€æ­£ç¡®ç¤ºä¾‹ âœ…ã€‘**
   ```
   âœ… æ­£ç¡®ç¤ºä¾‹1ï¼ˆåŸæ–‡æ²¡æ˜ç¡®æ ‡åºå·ï¼‰ï¼š
   åŸæ–‡ï¼š"æ°¨åŸºé…¸æœ‰å¤šç§æ€§è´¨ï¼ŒåŒ…æ‹¬ç‰©ç†æ€§è´¨ã€åŒ–å­¦æ€§è´¨ã€å…‰å­¦æ€§è´¨ç­‰"

   #### æ°¨åŸºé…¸çš„æ€§è´¨                  ï¼ˆâœ“ ä¸æ ‡æ•°å­—ï¼ŒåŸæ–‡æ²¡æ˜ç¡®æ ‡åºå·ï¼‰
   ##### ç‰©ç†æ€§è´¨ 3                    ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ##### åŒ–å­¦æ€§è´¨ 4                    ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ##### å…‰å­¦æ€§è´¨ 2                    ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰

   âœ… æ­£ç¡®ç¤ºä¾‹2ï¼ˆåŸæ–‡æ˜ç¡®æ ‡äº†åºå·ï¼‰ï¼š
   åŸæ–‡ï¼š"æ°¨åŸºé…¸æœ‰4ç§åŒ–å­¦æ€§è´¨ï¼š(1)é…¸ç¢±æ€§ (2)æˆç›ååº” (3)æ°§åŒ–è¿˜åŸååº” (4)ç¼©åˆååº”"

   #### æ°¨åŸºé…¸çš„åŒ–å­¦æ€§è´¨ 4              ï¼ˆâœ“ æ ‡æ•°å­—ï¼ŒåŸæ–‡æ˜ç¡®å†™äº†"4ç§"å’Œåºå·ï¼‰
   ##### é…¸ç¢±æ€§ 2                      ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ##### æˆç›ååº” 3                    ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ##### æ°§åŒ–è¿˜åŸååº” 2                ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ##### ç¼©åˆååº” 3                    ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰

   âœ… æ­£ç¡®ç¤ºä¾‹3ï¼ˆæ··åˆæƒ…å†µï¼‰ï¼š
   ## ç¬¬ä¸€ç«  æ°¨åŸºé…¸                    ï¼ˆä¸æ ‡æ•°å­—ï¼Œç« èŠ‚æ ‡é¢˜ï¼‰
   ### 1.1 æ°¨åŸºé…¸çš„åŸºæœ¬ç»“æ„            ï¼ˆä¸æ ‡æ•°å­—ï¼Œå°èŠ‚æ ‡é¢˜ï¼‰
   #### æ°¨åŸºé…¸çš„ç»“æ„ç‰¹ç‚¹              ï¼ˆä¸æ ‡æ•°å­—ï¼ŒåŸæ–‡æ²¡æ˜ç¡®æ ‡åºå·ï¼‰
   ##### åŸºæœ¬éª¨æ¶ 2                    ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ##### RåŸºå›¢ 3                       ï¼ˆâœ“ æ ‡æ•°å­—ï¼Œå¶å­èŠ‚ç‚¹ï¼‰
   ```

   **ã€å…³é”®æé†’ã€‘**
   - ä¸è¦è‡ªä½œä¸»å¼ ç»™ä¸­é—´èŠ‚ç‚¹æ ‡æ•°å­—ï¼
   - åªæœ‰åœ¨åŸæ–‡ä¸­æ˜ç¡®çœ‹åˆ°"æœ‰Xç§"ã€"(1)(2)(3)"ã€"ä¸€ã€äºŒã€ä¸‰"ç­‰æ ‡æ³¨æ—¶ï¼Œä¸­é—´èŠ‚ç‚¹æ‰æ ‡æ•°å­—
   - æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½å¿…é¡»æ ‡æ•°å­—ï¼Œä¸èƒ½é—æ¼

5. **ğŸ”´ğŸ”´ğŸ”´ ç»å¯¹ä¸è¦å†™ç­”æ¡ˆå†…å®¹ ğŸ”´ğŸ”´ğŸ”´**ï¼ˆæå…¶é‡è¦ï¼‰

   **ã€ä»€ä¹ˆæ˜¯ç­”æ¡ˆå†…å®¹ã€‘**
   - å…·ä½“çš„å®šä¹‰ã€è§£é‡Šã€è¯´æ˜
   - å…·ä½“çš„ç‰¹ç‚¹ã€æ­¥éª¤ã€è¿‡ç¨‹æè¿°
   - å…·ä½“çš„ä¾‹å­ã€æ•°æ®ã€å…¬å¼

   **ã€æ­£ç¡®åšæ³• âœ…ã€‘**
   - åªå†™çŸ¥è¯†ç‚¹çš„**åç§°/æ ‡é¢˜**
   - åªå†™è¿™ä¸ªçŸ¥è¯†ç‚¹æœ‰**å‡ æ¡è¦ç‚¹**
   - ä¸å†™å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆ

   **ã€é”™è¯¯ç¤ºä¾‹ âŒã€‘**
   ```
   âŒ é”™è¯¯ï¼šå†™äº†ç­”æ¡ˆå†…å®¹
   ##### ç«äº‰æ€§æŠ‘åˆ¶
   ###### åŒ–å­¦ç»“æ„ä¸åº•ç‰©ç›¸ä¼¼ 1
   ###### ç«äº‰é…¶ç»“åˆä½ç‚¹ 1
   ###### å½¢æˆé…¶-æŠ‘åˆ¶å‰‚å¤åˆç‰© 1
   ###### å‡å°‘åº•ç‰©ä¸é…¶ç»“åˆ 1
   ###### Vmaxä¸å˜ 1
   ###### Kmå€¼å¢å¤§ 1
   ```

   **ã€æ­£ç¡®ç¤ºä¾‹ âœ…ã€‘**
   ```
   âœ… æ­£ç¡®ï¼šåªå†™çŸ¥è¯†ç‚¹åç§°å’Œæ•°é‡
   ##### ç«äº‰æ€§æŠ‘åˆ¶ 6
   ```

   æˆ–è€…å¦‚æœè¦è¯¦ç»†å±•å¼€å±‚æ¬¡ï¼š
   ```
   âœ… æ­£ç¡®ï¼š
   ##### ç«äº‰æ€§æŠ‘åˆ¶
   ###### å®šä¹‰ 1
   ###### ä½œç”¨æœºåˆ¶ 2
   ###### åŠ¨åŠ›å­¦å‚æ•° 2
   ```

   **ã€æ ¸å¿ƒåŸåˆ™ã€‘**
   - è„‘å›¾çš„ç›®çš„æ˜¯**æç¤ºèƒŒè¯µ**ï¼Œä¸æ˜¯**å±•ç¤ºç­”æ¡ˆ**
   - ç”¨æˆ·çœ‹åˆ°"ç«äº‰æ€§æŠ‘åˆ¶ 6"ï¼Œå°±çŸ¥é“è¦èƒŒè¯µ6ä¸ªè¦ç‚¹
   - ç”¨æˆ·çœ‹åˆ°çŸ¥è¯†ç‚¹åç§°ï¼Œå°±èƒ½å›å¿†èµ·å…·ä½“å†…å®¹
   - ç»å¯¹ä¸è¦æŠŠå…·ä½“å†…å®¹å†™å‡ºæ¥ï¼

ã€åˆ†æç­–ç•¥ - ğŸ”´ å¿…é¡»é€å±‚æ·±å…¥åˆ†æ ğŸ”´ã€‘

**ç¬¬1æ­¥ï¼šè¯†åˆ«å¤§çº²ç»“æ„**
- è¯†åˆ«æ‰€æœ‰ç« èŠ‚æ ‡é¢˜ï¼ˆ##ï¼‰
- è¯†åˆ«æ¯ç« çš„æ‰€æœ‰å°èŠ‚ï¼ˆ###ï¼‰

**ç¬¬2æ­¥ï¼šæå–æ¯èŠ‚çš„æ‰€æœ‰çŸ¥è¯†ç‚¹**ï¼ˆ####, #####ï¼‰
- é€æ®µé˜…è¯»æ¯ä¸€èŠ‚çš„å†…å®¹
- è¯†åˆ«æ¯ä¸ªæ®µè½çš„ä¸»é¢˜
- æå–æ¯ä¸ªå°æ ‡é¢˜ã€é»‘ä½“å­—ã€é‡ç‚¹è¯æ±‡
- å°†ç›¸å…³å†…å®¹å½’ç±»æ•´ç†

**ç¬¬3æ­¥ï¼šæ·±å…¥å±•å¼€æ¯ä¸ªçŸ¥è¯†ç‚¹**ï¼ˆ######, #######, ########ï¼‰
- å¯¹æ¯ä¸ªçŸ¥è¯†ç‚¹ï¼Œåˆ†æåŒ…å«å“ªäº›æ–¹é¢ï¼š
  * å¦‚æœæ˜¯æ¦‚å¿µï¼Œæå–ï¼šå®šä¹‰ã€ç‰¹ç‚¹ã€åˆ†ç±»
  * å¦‚æœæ˜¯ç»“æ„ï¼Œæå–ï¼šç»„æˆã€å½¢å¼ã€ç‰¹å¾
  * å¦‚æœæ˜¯è¿‡ç¨‹ï¼Œæå–ï¼šæ­¥éª¤ã€é˜¶æ®µã€æ¡ä»¶
  * å¦‚æœæ˜¯åŠŸèƒ½ï¼Œæå–ï¼šä½œç”¨ã€æ„ä¹‰ã€å½±å“å› ç´ 
- æ¯ä¸ªæ–¹é¢å†ç»§ç»­ç»†åˆ†ï¼Œç›´åˆ°æœ€å°çŸ¥è¯†ç‚¹

**ç¬¬4æ­¥ï¼šæ ‡æ³¨æ•°å­—**
- å¯¹æ¯ä¸ªå¶å­èŠ‚ç‚¹æ ‡æ³¨è¦ç‚¹æ•°é‡
- å¯¹ä¸­é—´èŠ‚ç‚¹ï¼Œåªåœ¨åŸæ–‡æ˜ç¡®æ ‡æ³¨åºå·æ—¶æ‰æ ‡æ•°å­—

**å…³é”®æé†’ï¼š**
- ä¸è¦æ¦‚æ‹¬ï¼Œè¦è¯¦ç»†åˆ—ä¸¾
- ä¸è¦é—æ¼ï¼Œè¦é€å­—åˆ†æ
- ä¸è¦æµ…å±‚ï¼Œè¦æ·±å…¥å±•å¼€
- è¦æŠŠæ•™æçš„æ‰€æœ‰ç»†èŠ‚éƒ½æå–æˆæ€ç»´å¯¼å›¾èŠ‚ç‚¹

ä¹¦åï¼š{pdf_name}

æ•™æå†…å®¹ï¼š
{pdf_text[:max_chunk_size]}

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼ç”Ÿæˆå®Œæ•´è¯¦ç»†çš„æ€ç»´å¯¼å›¾ï¼š"""

    print(f"æ­£åœ¨ä½¿ç”¨ AI ç”Ÿæˆè¯¦ç»†æ€ç»´å¯¼å›¾...")
    sys.stdout.flush()

    completion = client.chat.completions.create(
        model="qwen3-max",
        messages=[
            {
                "role": "system",
                "content": """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•™è‚²ä¸“å®¶ï¼Œæ“…é•¿åˆ†ææ•™æå†…å®¹å¹¶ç”Ÿæˆè¯¦ç»†å®Œæ•´çš„èƒŒè¯µæç¤ºè„‘å›¾ã€‚

ğŸ”´ğŸ”´ğŸ”´ æ ¸å¿ƒä»»åŠ¡ï¼šç”ŸæˆèƒŒè¯µæç¤ºè„‘å›¾ï¼ˆä¸æ˜¯ç­”æ¡ˆå±•ç¤ºè„‘å›¾ï¼‰ğŸ”´ğŸ”´ğŸ”´

ã€ä»»åŠ¡1ï¼šè¯†åˆ«æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼ˆè¯¦ç»†å®Œæ•´ï¼‰ã€‘
- é€å­—é€å¥åˆ†ææ•™æï¼Œä¸é—æ¼ä»»ä½•çŸ¥è¯†ç‚¹
- å¿…é¡»æœ‰ 4-6 å±‚çš„å±‚çº§ç»“æ„
- è¯†åˆ«æ¯ä¸ªçŸ¥è¯†ç‚¹çš„æ‰€æœ‰å­æ–¹é¢ï¼šå®šä¹‰ã€ç»„æˆã€åˆ†ç±»ã€ç‰¹ç‚¹ã€åŠŸèƒ½ã€è¿‡ç¨‹ç­‰
- ä¸è¦æ¦‚æ‹¬ï¼Œè¦æŠŠæ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½åˆ—å‡ºæ¥

ã€ä»»åŠ¡2ï¼šåªå†™åç§°ï¼Œä¸å†™ç­”æ¡ˆã€‘
- âœ… åªå†™çŸ¥è¯†ç‚¹çš„**åç§°/æ ‡é¢˜**
- âœ… åªæ ‡æ³¨æœ‰**å‡ ä¸ªè¦ç‚¹**
- âŒ ç»å¯¹ä¸è¦å†™å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆ
- âŒ ä¸è¦å†™å®šä¹‰ã€è§£é‡Šã€è¯´æ˜ã€ä¸¾ä¾‹ç­‰ç­”æ¡ˆ

ç¤ºä¾‹å¯¹æ¯”ï¼š
âŒ é”™è¯¯ï¼ˆå†™äº†ç­”æ¡ˆï¼‰ï¼š
##### ç«äº‰æ€§æŠ‘åˆ¶
###### åŒ–å­¦ç»“æ„ä¸åº•ç‰©ç›¸ä¼¼ 1
###### ç«äº‰é…¶ç»“åˆä½ç‚¹ 1

âœ… æ­£ç¡®ï¼ˆåªå†™åç§°ï¼‰ï¼š
##### ç«äº‰æ€§æŠ‘åˆ¶ 6

ã€ä»»åŠ¡3ï¼šæ­£ç¡®æ ‡æ³¨æ•°å­—ã€‘
- å¶å­èŠ‚ç‚¹å¿…é¡»æ ‡æ•°å­—
- ä¸­é—´èŠ‚ç‚¹åªåœ¨åŸæ–‡æ˜ç¡®æ ‡æ³¨åºå·æ—¶æ‰æ ‡æ•°å­—

ã€æ ¸å¿ƒåŸåˆ™ã€‘
è„‘å›¾æ˜¯èƒŒè¯µæç¤ºå·¥å…·ï¼Œç”¨æˆ·çœ‹åˆ°"ç«äº‰æ€§æŠ‘åˆ¶ 6"å°±çŸ¥é“è¦èƒŒ6ä¸ªè¦ç‚¹ï¼Œçœ‹åˆ°çŸ¥è¯†ç‚¹åç§°å°±èƒ½å›å¿†å†…å®¹ã€‚ç»å¯¹ä¸è¦æŠŠç­”æ¡ˆå†™å‡ºæ¥ï¼"""
            },
            {
                "role": "user",
                "content": prompt
            }
        ],
        temperature=0.2,  # é™ä½æ¸©åº¦ä»¥è·å¾—æ›´ç¨³å®šã€æ›´ç¬¦åˆè§„åˆ™çš„è¾“å‡º
    )

    result = completion.choices[0].message.content
    print(f"æ€ç»´å¯¼å›¾ç”Ÿæˆå®Œæˆï¼Œé•¿åº¦: {len(result)} å­—ç¬¦")
    sys.stdout.flush()

    return result


def remove_intermediate_numbers(md_text):
    """ç§»é™¤ä¸­é—´èŠ‚ç‚¹çš„æ•°å­—æ ‡æ³¨,åªä¿ç•™å¶å­èŠ‚ç‚¹çš„æ•°å­—"""
    import sys

    print("æ­£åœ¨ç§»é™¤ä¸­é—´èŠ‚ç‚¹çš„æ•°å­—æ ‡æ³¨...")
    sys.stdout.flush()

    lines = md_text.split('\n')
    result = []

    for i in range(len(lines)):
        line = lines[i]

        # æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜è¡Œ
        if line.strip().startswith('#'):
            # è®¡ç®—å½“å‰æ ‡é¢˜çš„å±‚çº§
            current_level = len(line) - len(line.lstrip('#'))

            # æ£€æŸ¥ä¸‹ä¸€ä¸ªéç©ºè¡Œæ˜¯å¦æ˜¯æ›´æ·±å±‚çº§çš„æ ‡é¢˜
            has_children = False
            for j in range(i + 1, len(lines)):
                next_line = lines[j].strip()
                if not next_line:
                    continue
                if next_line.startswith('#'):
                    next_level = len(lines[j]) - len(lines[j].lstrip('#'))
                    if next_level > current_level:
                        has_children = True
                    break

            # å¦‚æœæœ‰å­èŠ‚ç‚¹,ç§»é™¤æ•°å­—æ ‡æ³¨
            if has_children:
                # ç§»é™¤æœ«å°¾çš„æ•°å­—(æ ¼å¼: "æ ‡é¢˜ æ•°å­—")
                line = re.sub(r'\s+\d+\s*$', '', line)

        result.append(line)

    print("ä¸­é—´èŠ‚ç‚¹æ•°å­—ç§»é™¤å®Œæˆ")
    sys.stdout.flush()
    return '\n'.join(result)


def generate_simple_mindmap(pdf_text, pdf_name):
    """ç®€å•çš„æ€ç»´å¯¼å›¾ç”Ÿæˆï¼ˆä¸ä½¿ç”¨ APIï¼‰"""
    lines = pdf_text.split('\n')

    # ç®€å•çš„ç»“æ„æå–é€»è¾‘
    mindmap = [f"# {pdf_name}"]
    mindmap.append("")

    current_section = None
    for line in lines[:500]:  # åªå¤„ç†å‰ 500 è¡Œ
        line = line.strip()
        if not line:
            continue

        # æ£€æµ‹ç« èŠ‚æ ‡é¢˜ï¼ˆé€šå¸¸æ˜¯æ•°å­—å¼€å¤´æˆ–è€…è¾ƒçŸ­çš„è¡Œï¼‰
        if re.match(r'^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+[ç« èŠ‚]', line) or \
           re.match(r'^\d+[\.\ã€]', line):
            if len(line) < 50:
                mindmap.append(f"## {line}")
                current_section = line
        elif current_section and len(line) < 100:
            mindmap.append(f"- {line}")

    return "\n".join(mindmap)


def convert_md_to_xmind(md_file, output_dir="output"):
    """ä½¿ç”¨ md2xmind è½¬æ¢ Markdown åˆ° XMind"""
    import md2xmind

    output_path = Path(output_dir)
    output_path.mkdir(exist_ok=True)

    xmind_file = output_path / f"{Path(md_file).stem}.xmind"

    print(f"æ­£åœ¨è½¬æ¢ {md_file} åˆ° XMind æ ¼å¼...")

    try:
        # ä½¿ç”¨ md2xmind API
        topic_name = Path(md_file).stem
        md2xmind.start_trans_file(str(md_file), str(xmind_file), topic_name)
        print(f"è½¬æ¢æˆåŠŸ: {xmind_file}")
        return xmind_file
    except Exception as e:
        print(f"è½¬æ¢å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return None


def main():
    """ä¸»å‡½æ•°"""
    # åŠ è½½ç¯å¢ƒå˜é‡
    load_dotenv()

    data_dir = Path("data")
    output_dir = Path("output")
    output_dir.mkdir(exist_ok=True)

    # è·å–æ‰€æœ‰ DOCX æ–‡ä»¶
    docx_files = list(data_dir.glob("*.docx"))

    if not docx_files:
        print("æœªæ‰¾åˆ° DOCX æ–‡ä»¶")
        return

    print(f"æ‰¾åˆ° {len(docx_files)} ä¸ª DOCX æ–‡ä»¶")

    for docx_file in docx_files:
        print(f"\n{'='*60}")
        print(f"å¤„ç†: {docx_file.name}")
        print(f"{'='*60}")

        try:
            # 1. æå– DOCX æ–‡æœ¬
            doc_text = extract_docx_text(docx_file)

            if not doc_text or len(doc_text.strip()) == 0:
                print(f"è­¦å‘Š: DOCX æ–‡æœ¬ä¸ºç©ºæˆ–æ— æ³•æå–ï¼Œè·³è¿‡æ­¤æ–‡ä»¶")
                continue

            # 2. ç”Ÿæˆæ€ç»´å¯¼å›¾ Markdown
            doc_name = docx_file.stem
            mindmap_md = generate_mindmap_md(doc_text, doc_name)

            # 3. ä¿å­˜ Markdown æ–‡ä»¶
            md_file = output_dir / f"{doc_name}.md"
            with open(md_file, 'w', encoding='utf-8') as f:
                f.write(mindmap_md)
            print(f"å·²ä¿å­˜ Markdown: {md_file}")

            # 4. è½¬æ¢ä¸º XMind
            xmind_file = convert_md_to_xmind(md_file, output_dir)

        except Exception as e:
            print(f"å¤„ç† {docx_file.name} æ—¶å‡ºé”™: {e}")
            import traceback
            traceback.print_exc()
            continue

    print(f"\n{'='*60}")
    print("å…¨éƒ¨å¤„ç†å®Œæˆï¼")
    print(f"è¾“å‡ºç›®å½•: {output_dir.absolute()}")


if __name__ == "__main__":
    main()
